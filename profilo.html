<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Profilo & Impostazioni — LDP</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; }

  /* Navbar minimal */
  .nav-link {
    position: relative;
    padding-bottom: 3px;
    transition: all 0.2s ease;
    color:#334155;
    font-weight:500;
  }
  .nav-link::after {
    content:"";
    position:absolute;
    left:0;
    bottom:0;
    width:0%;
    height:2px;
    background:#0ea5e9;
    transition:width 0.3s ease;
  }
  .nav-link:hover::after { width:100%; }
  .nav-link.active { color:#0ea5e9; font-weight:600; }
  .nav-link.active::after { width:100%; }

  /* Animazione evidenziazione storico */
  .highlight-change {
    background-color: #d1fae5;
    transition: background-color 2s ease;
  }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="bg-white/80 backdrop-blur-md border-b shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
    <a href="index.html" class="flex items-center gap-3">
      <div class="w-50 h-10 rounded-md overflow-hidden shadow-md">
        <img src="images/logo.png" alt="Logo LDP" class="w-full h-full object-cover">
      </div>
      <div>
        <div class="font-semibold text-slate-800 text-lg">ConsulenzaLab</div>
        <div class="text-xs text-slate-500">Legale · Fiscale · Dati</div>
      </div>
    </a>

    <a href="index.html" class="hidden md:inline-flex items-center gap-1 text-sm text-slate-600 font-medium hover:text-slate-800 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6" />
      </svg>
      Torna alla Home
    </a>

    <nav class="hidden md:flex items-center gap-6 text-sm font-medium relative">
      <a href="index.html" class="nav-link">Home</a>
      <div class="relative group">
        <button class="nav-link flex items-center gap-1">Informatica
          <svg class="w-3 h-3 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="absolute left-0 mt-2 w-40 bg-white shadow-lg rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
        
          <a href="powerbi.html" class="block px-4 py-2 hover:bg-slate-100">Dashboard</a>
          <a href="ml.html" class="block px-4 py-2 hover:bg-slate-100">Machine Learning</a>
          <a href="ai-reports.html" class="block px-4 py-2 hover:bg-slate-100">AI Reports</a>
        </div>
      </div>
      <a href="fatture.html" class="nav-link">Fatture</a>
      <a href="documenti.html" class="nav-link">Documenti</a>
      <a href="profilo.html" class="nav-link active">Profilo</a>
      <a href="help.html" class="nav-link">Help</a>
      <button id="btn-open-login" class="ml-4 px-4 py-2 rounded-md bg-green-600 text-white shadow hover:bg-green-700 transition">
        Accedi / Registrati
      </button>
    </nav>
  </div>
</header>

<!-- ===== MODAL LOGIN / REGISTER ===== -->
<div id="modal-auth" class="fixed inset-0 flex items-center justify-center bg-black/40 hidden z-50">
  <div class="w-full max-w-xl bg-white rounded-xl overflow-hidden shadow-xl">
    <div class="p-6 grid grid-cols-2 gap-6">
      <div>
        <h3 class="text-xl font-semibold">Accedi o registrati</h3>
        <p class="text-sm text-slate-600 mt-2">Per accedere al piano Base o ai Premium crea un account.</p>
        <div class="mt-4">
          <label for="auth-email" class="block text-sm font-medium text-slate-700">Email</label>
          <input id="auth-email" name="email" class="w-full mt-1 p-2 border rounded-md" type="email" placeholder="Inserisci la tua email" />
        </div>
        <div class="mt-3">
          <label for="auth-pass" class="block text-sm font-medium text-slate-700">Password</label>
          <input id="auth-pass" name="password" class="w-full mt-1 p-2 border rounded-md" type="password" placeholder="Inserisci la tua password" />
        </div>
        <div class="mt-4 flex gap-3 items-center">
          <button id="btn-login" class="px-4 py-2 rounded-md bg-green-600 text-white">Accedi</button>
          <button id="btn-register" class="px-4 py-2 rounded-md border">Registrati</button>
          <button id="btn-close-modal" class="ml-auto text-sm text-slate-500">Chiudi</button>
        </div>
        <p class="text-xs text-slate-500 mt-3">Nota: mockup front-end. Integrare con la vostra API di autenticazione.</p>
      </div>
      <div>
        <h4 class="font-semibold">Perché registrarsi?</h4>
        <ul class="text-sm text-slate-600 mt-3 space-y-2">
          <li>• Salva i tuoi report</li>
          <li>• Sblocca il piano Base</li>
          <li>• Passa ai Premium quando vuoi</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- ===== CONTENUTO PROFILO ===== -->
<main class="max-w-7xl mx-auto px-6 py-8 grid md:grid-cols-2 gap-6">
  <section class="p-6 rounded-xl bg-white shadow hover:shadow-lg transition space-y-4">
    <h3 class="text-xl font-semibold">👤 Informazioni personali</h3>
    <div class="flex items-center gap-4 mb-4">
      <div class="w-24 h-24 rounded-full flex items-center justify-center bg-green-600 text-white text-2xl font-bold" id="profileInitials">??</div>
    </div>

    <form id="profileForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-slate-700">Nome</label>
        <input type="text" id="nome" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Cognome</label>
        <input type="text" id="cognome" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Nato a</label>
        <input type="text" id="nato_a" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Provincia nascita</label>
        <input type="text" id="prov_nascita" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Data di nascita</label>
        <input type="date" id="data_nascita" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Codice fiscale</label>
        <input type="text" id="codice_fiscale" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Residenza (via, largo, piazza…)</label>
        <input type="text" id="residenza_via" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium text-slate-700">CAP</label>
          <input type="text" id="residenza_cap" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Città</label>
          <input type="text" id="residenza_citta" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Prov.</label>
          <input type="text" id="residenza_prov" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
        </div>
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Domicilio (se diverso dalla residenza)</label>
        <input type="text" id="domicilio_via" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium text-slate-700">CAP</label>
          <input type="text" id="domicilio_cap" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Città</label>
          <input type="text" id="domicilio_citta" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Prov.</label>
          <input type="text" id="domicilio_prov" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
        </div>
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Telefono fisso</label>
        <input type="text" id="telefono_fisso" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Telefono cellulare</label>
        <input type="text" id="telefono_cellulare" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Fax</label>
        <input type="text" id="fax" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">E-mail</label>
        <input type="email" id="email" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Beneficiario (intestato a)</label>
        <input type="text" id="beneficiario" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium text-slate-700">Data</label>
          <input type="date" id="data" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Luogo</label>
          <input type="text" id="luogo" class="mt-1 block w-full border rounded px-3 py-2 text-sm">
        </div>
      </div>
    
      <div>
        <label class="block text-sm font-medium text-slate-700">Firma</label>
        <input type="text" id="firma" placeholder="Firma digitale o nome completo"
          class="mt-1 block w-full border rounded px-3 py-2 text-sm">
      </div>
    
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">💾 Salva Modifiche</button>
    </form>

  </section>


  <!-- ===== SCRIPT PER SALVARE PROFILO E GENERARE PDF ===== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  let user = JSON.parse(localStorage.getItem("utente")) || {
    nome:"", cognome:"", email:"", plan:"base", password:"", history:[]
  };

  const profileForm = document.getElementById("profileForm");
  const historyList = document.getElementById("historyList");
  const profileInitials = document.getElementById("profileInitials");

  function saveUser(){ localStorage.setItem("utente", JSON.stringify(user)); }
  function getInitials(nome, cognome){ return (nome?.charAt(0).toUpperCase()||"") + (cognome?.charAt(0).toUpperCase()||""); }

  function renderHistory(newEntry=false){
    historyList.innerHTML="";
    user.history.forEach((entry,i)=>{
      const li=document.createElement('li');
      li.textContent=entry;
      if(i===0 && newEntry) li.classList.add('highlight-change');
      historyList.appendChild(li);
      if(li.classList.contains('highlight-change')){
        setTimeout(()=>li.classList.remove('highlight-change'),2000);
      }
    });
  }

  function renderProfile(){
    profileInitials.textContent = getInitials(user.nome, user.cognome);
    document.getElementById("nome").value = user.nome;
    document.getElementById("cognome").value = user.cognome;
    document.getElementById("email").value = user.email;
    renderHistory();
  }

  renderProfile();

  profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const oldData = {...user};

    // Aggiorna dati utente
    user.nome = document.getElementById("nome").value;
    user.cognome = document.getElementById("cognome").value;
    user.email = document.getElementById("email").value;
    // Aggiorna eventuali altri campi se vuoi
    const timestamp = new Date().toLocaleString();
    user.history.unshift(`${timestamp} - Modifiche salvate`);

    saveUser();
    renderProfile(true);

    // Raccogli dati da inviare al PDF
    const dati = {
      nome: document.getElementById("nome").value,
      cognome: document.getElementById("cognome").value,
      nato_a: document.getElementById("nato_a").value,
      prov_nascita: document.getElementById("prov_nascita").value,
      data_nascita: document.getElementById("data_nascita").value,
      codice_fiscale: document.getElementById("codice_fiscale").value,
      residenza_via: document.getElementById("residenza_via").value,
      residenza_cap: document.getElementById("residenza_cap").value,
      residenza_citta: document.getElementById("residenza_citta").value,
      residenza_prov: document.getElementById("residenza_prov").value,
      domicilio_via: document.getElementById("domicilio_via").value,
      domicilio_cap: document.getElementById("domicilio_cap").value,
      domicilio_citta: document.getElementById("domicilio_citta").value,
      domicilio_prov: document.getElementById("domicilio_prov").value,
      telefono_fisso: document.getElementById("telefono_fisso").value,
      telefono_cellulare: document.getElementById("telefono_cellulare").value,
      fax: document.getElementById("fax").value,
      email: document.getElementById("email").value,
      beneficiario: document.getElementById("beneficiario").value,
      data: document.getElementById("data").value,
      luogo: document.getElementById("luogo").value,
      firma: document.getElementById("firma").value
    };

    try {
      const response = await fetch("/api/compila-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dati)
      });

      if (!response.ok) throw new Error("Errore generazione PDF");

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "profilo_compilato.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      alert("✅ PDF compilato scaricato con successo!");
    } catch(err){
      console.error(err);
      alert("❌ Errore durante la compilazione del PDF");
    }
  });
});
</script>




  <section class="p-6 rounded-xl bg-white shadow hover:shadow-lg transition">
    <h3 class="text-xl font-semibold mb-4">📜 Storico modifiche</h3>
    <ul id="historyList" class="list-disc list-inside text-sm text-slate-700"></ul>
  </section>
</main>

<!-- ===== FOOTER ===== -->
<footer class="bg-white/80 backdrop-blur-md border-t mt-16 py-6 text-center text-sm text-slate-500">
  &copy; 2025 ConsulenzaLab. Tutti i diritti riservati.
</footer>


<!-- Firebase App (obbligatorio) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>





<!-- ===== SCRIPT UNIFICATO ===== -->
<script>
let user = JSON.parse(localStorage.getItem("utente")) || {
  nome:"", cognome:"", email:"", plan:"base", password:"", history:[]
};

document.addEventListener('DOMContentLoaded', ()=>{
  const profileForm=document.getElementById("profileForm");
  const historyList=document.getElementById("historyList");
  const profileInitials=document.getElementById("profileInitials");

  const modalAuth=document.getElementById('modal-auth');
  const btnOpen=document.getElementById('btn-open-login');
  const btnClose=document.getElementById('btn-close-modal');
  const btnLogin=document.getElementById('btn-login');
  const btnRegister=document.getElementById('btn-register');
  const btnDelete=document.getElementById('delete-account');

  function saveUser(){ localStorage.setItem("utente",JSON.stringify(user)); }
  function getInitials(nome,cognome){ return (nome?.charAt(0).toUpperCase()||"")+(cognome?.charAt(0).toUpperCase()||""); }
  
  function renderHistory(newEntry=false){
    historyList.innerHTML="";
    user.history.forEach((entry,i)=>{
      const li=document.createElement('li');
      li.textContent=entry;
      if(i===0 && newEntry) li.classList.add('highlight-change');
      historyList.appendChild(li);
      if(li.classList.contains('highlight-change')){
        setTimeout(()=>li.classList.remove('highlight-change'),2000);
      }
    });
  }

  function renderProfile(){ 
    profileInitials.textContent=getInitials(user.nome,user.cognome);
    document.getElementById("nome").value=user.nome;
    document.getElementById("cognome").value=user.cognome;
    document.getElementById("email").value=user.email;
    document.getElementById("plan").value=user.plan;
    renderHistory();
  }

  function highlightNav(){
    const currentPage=window.location.pathname.split("/").pop();
    document.querySelectorAll(".nav-link").forEach(link=>{ link.classList.toggle("active",link.getAttribute("href")===currentPage); });
  }

  // Modal login/register
  btnOpen?.addEventListener('click',()=>modalAuth.classList.remove('hidden'));
  btnClose?.addEventListener('click',()=>modalAuth.classList.add('hidden'));
  modalAuth.addEventListener('click', e=>{ if(e.target===modalAuth) modalAuth.classList.add('hidden'); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') modalAuth.classList.add('hidden'); });

  // Login
  btnLogin?.addEventListener('click', async () => {
    const email = document.getElementById('auth-email').value;
    const pass = document.getElementById('auth-pass').value;
    try {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password: pass })
      });
      const data = await res.json();
      if(data.success){
        localStorage.setItem('utente', JSON.stringify(data.user)); // conserva info locali
        alert('✅ Login riuscito!');
        modalAuth.classList.add('hidden');
        renderProfile();
      } else alert('❌ Credenziali non valide.');
    } catch(err){ console.error(err); alert('Errore server'); }
  });

  // Registrazione
  btnRegister?.addEventListener('click', async () => {
    const email = document.getElementById('auth-email').value;
    const pass = document.getElementById('auth-pass').value;
    try {
      const res = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password: pass })
      });
      const data = await res.json();
      if(data.success){
        localStorage.setItem('utente', JSON.stringify(data.user));
        alert('✅ Registrazione completata!');
        modalAuth.classList.add('hidden');
        renderProfile();
      } else alert(data.message || 'Errore registrazione.');
    } catch(err){ console.error(err); alert('Errore server'); }
  });


  // Salvataggio profilo
  profileForm?.addEventListener("submit",(e)=>{
    e.preventDefault();
    const oldData={...user};
    user.nome=document.getElementById("nome").value;
    user.cognome=document.getElementById("cognome").value;
    user.email=document.getElementById("email").value;
    user.plan=document.getElementById("plan").value;
    const pwd=document.getElementById("password").value; if(pwd) user.password=pwd;

    const timestamp=new Date().toLocaleString();
    const changes=[];
    if(oldData.nome!==user.nome) changes.push(`Nome: "${oldData.nome}" → "${user.nome}"`);
    if(oldData.cognome!==user.cognome) changes.push(`Cognome: "${oldData.cognome}" → "${user.cognome}"`);
    if(oldData.email!==user.email) changes.push(`Email: "${oldData.email}" → "${user.email}"`);
    if(oldData.plan!==user.plan) changes.push(`Piano: "${oldData.plan}" → "${user.plan}"`);
    if(pwd) changes.push("Password cambiata");
    if(changes.length) user.history.unshift(`${timestamp} - ${changes.join(", ")}`);

    

    saveUser();
    renderProfile(true);
    alert("✅ Impostazioni salvate correttamente!");
  });

  // Eliminazione account
  btnDelete?.addEventListener('click',(e)=>{
    e.preventDefault();
    if(!confirm("⚠️ Sei sicuro di eliminare il tuo account? Tutti i dati saranno rimossi.")) return;
    localStorage.removeItem('utente');
    user={nome:"",cognome:"",email:"",plan:"base",password:"",history:[]};
    renderProfile();
    alert("✅ Account eliminato con successo!");
  });

  renderProfile();
  highlightNav();
});






</script>

</body>
</html>
